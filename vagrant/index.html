<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>用 Vagrant 统一开发环境 | 明无梦</title>
  <meta name="description" content="WHY VAGRANT? Vagrant provides easy to configure, reproducible, and portable work environments built on top of industry-standard technology and controlled by a …">
  <link rel="canonical" href="https://www.dreamxu.com/vagrant/">
    <link rel="stylesheet" href="/css/style.min.2a2aa4ed426afcd7c5ffde31042cdd4d55ebbfcab2754fcfd5577a4a7b59019b.css" integrity="sha256-Kiqk7UJq/NfF/94xBCzdTVXrv8qydU/P1Vd6SntZAZs=" crossorigin="anonymous">
  <script type="text/javascript" src="/js/bundle.min.441c485d1d9104b8017416429af24d2115fb80b39ccd1f1cb4907dc6c9d0e84d.js" integrity="sha256-RBxIXR2RBLgBdBZCmvJNIRX7gLOczR8ctJB9xsnQ6E0=" defer></script>

  <link rel="icon" href="/favicon.ico" type="image/x-icon">
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XNJSCC1KSF"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-XNJSCC1KSF', { 'anonymize_ip': false });
}
</script>

</head>


<body>

<header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">明无梦</a>

    <nav class="site-nav">
      <a class="menu-icon" id="js-nav-menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <a class="menu-icon-activate" id="js-nav-menu-icon-activate">
        <svg viewBox="0 0 36 15">
          <path fill="#424242" d="m36,1.484c0,0.82 -0.665,1.484 -1.484,1.484l-33.032,0c-0.819,0.001 -1.484,-0.664 -1.484,-1.484l0,0c0,-0.819 0.665,-1.484 1.484,-1.484l33.032,0c0.82,0 1.484,0.665 1.484,1.484l0,0z"/>
          <path fill="#424242" d="m36,7.516c0,0.819 -0.665,1.484 -1.484,1.484l-33.032,0c-0.819,0 -1.484,-0.665 -1.484,-1.484l0,0c0,-0.82 0.665,-1.484 1.484,-1.484l33.032,0c0.82,-0.001 1.484,0.664 1.484,1.484l0,0z"/>
          <path fill="#424242" d="m36,13.516c0,0.819 -0.665,1.484 -1.484,1.484l-33.032,0c-0.819,0 -1.484,-0.665 -1.484,-1.484l0,0c0,-0.82 0.665,-1.484 1.484,-1.484l33.032,0c0.82,-0.001 1.484,0.664 1.484,1.484l0,0z"/>
        </svg>
      </a>

      <div class="trigger" id="js-nav-menu-trigger">
        <a class="page-link" href="/archive/">归档</a>
        <a class="page-link" href="/tags/">标签</a>
        <a class="page-link" href="/books/">书籍</a>
        <a class="page-link" href="/about/">关于</a>
        <a class="page-link" href="/rss.xml">订阅</a>
      </div>
    </nav>

  </div>

</header>


<div class="content">
  <div class="wrapper">
    

<article class="post">

  <header class="post-header">
    <h1 class="post-title"><a href="/vagrant/">用 Vagrant 统一开发环境</a></h1>
    <ul class="post-meta">
      <li class="published-date">2014-09-06</li>
      
        <li class="updated-date"> | 更新: 2015-03-09</li>
        <li> | 标签: </li>
          <li class="post-tag"><a href="/tags/?names=%e8%ae%b0%e5%bd%95#tag-list-display">记录</a></li>
          <li class="post-tag"><a href="/tags/?names=Vagrant#tag-list-display">Vagrant</a></li>
          <li class="post-tag"><a href="/tags/?names=VirtualBox#tag-list-display">VirtualBox</a></li>
          <li class="post-tag"><a href="/tags/?names=Parallels#tag-list-display">Parallels</a></li>
    </ul>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="why-vagrant">WHY VAGRANT?</h2>
<blockquote>
<p>Vagrant provides easy to configure, reproducible, and portable work environments built on top of industry-standard technology and controlled by a single consistent workflow to help maximize the productivity and flexibility of you and your team.</p>
<p>To achieve its magic, Vagrant stands on the shoulders of giants. Machines are provisioned on top of VirtualBox, VMware, AWS, or any other provider. Then, industry-standard provisioning tools such as shell scripts, Chef, or Puppet, can be used to automatically install and configure software on the machine.</p>
</blockquote>
<p>——以上内容摘自官网</p>
<p>因其是使用虚拟机的，所以虚拟机的好处全部都有，你可以随便折腾，弄得不爽了可以马上复原，真的是很方便。也简化了操作虚拟机的步骤，一条命令即可创建一个虚拟系统，即开即用</p>
<h2 id="安装">安装</h2>
<ul>
<li>
<p>下载并安装 <a href="https://www.virtualbox.org/">VirtualBox</a> 虚拟机</p>
</li>
<li>
<p>下载并安装 <a href="http://www.vagrantup.com/">Vagrant</a></p>
</li>
</ul>
<h2 id="添加-box">添加 Box</h2>
<p>Box 理解为一个打包好的操作系统环境就好了<br>
可以自己做，也可以直接下载制作好的<br>
Vargrant 将 box 解包后放在 /.vagrant.d/boxes 文件夹</p>
<h3 id="通过命令直接下载">通过命令直接下载</h3>
<p>例如下载 Ubuntu 官方创建的 Ubuntu Server 64-bit 14.04 的 box<br>
其中的 <code>Ubuntu_Server_14.04</code> 是自己设定的 box 名字</p>
<pre><code>vagrant box add Ubuntu_Server_14.04 ubuntu/trusty64
</code></pre>
<p>Box 可以去 <a href="https://vagrantcloud.com/">Vagrant Cloud</a> 找</p>
<h3 id="手动下载-box">手动下载 box</h3>
<p>例如下载 Ubuntu 的 <a href="http://cloud-images.ubuntu.com/vagrant/">box</a>, 下载完成之后添加一下 box</p>
<pre><code>vagrant box add Ubuntu_Server_14.04 ~/Inbox/trusty-server-cloudimg-amd64-vagrant-disk1.box
</code></pre>
<h3 id="自己制作-base-box">自己制作 base box</h3>
<p>第一次使用 Vagrant 建议跳过这一步骤，<a href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%92%8C%E9%85%8D%E7%BD%AE">到下一步</a>，直接使用制作好的 base box, 体会了 Vagrant 之后再来自己制作 base box</p>
<p>人家制作好的 box 或许没有你需要的，那么就需要自己来制作了</p>
<h4 id="使用-veewee-工具创建虚拟机为-parallels">使用 Veewee 工具创建（虚拟机为 Parallels）</h4>
<ol>
<li>
<p>安装好 Ruby 之后，用如下命令安装 Veewee</p>
<pre><code>gem install veewee
</code></pre>
</li>
<li>
<p>查看支持的模板</p>
<pre><code>veewee parallels templates
</code></pre>
</li>
</ol>
<p>（未完成，博主还没有实践，或许以后会补全）</p>
<h4 id="手动创建虚拟机为-parallels">手动创建（虚拟机为 Parallels）</h4>
<ol>
<li>
<p>在 Parallels 中新建一个虚拟机，比如名字为 Ubuntu-14.04.2-vagrant<br>
把不需要的功能都关闭了，比如共享应用什么的，硬件配置自己选择合适的</p>
<p>以下是推荐系统设置</p>
<pre><code>Root Password: vagrant
Main account login: vagrant
Main account password: vagrant
</code></pre>
</li>
<li>
<p>安装一些必要的软件，例如 Parallels Tools, SSH</p>
<p>以下是安装 SSH 的方法</p>
<ol>
<li>
<p>先去 <a href="https://github.com/mitchellh/vagrant/blob/master/keys/vagrant.pub">insecure keypair</a><br>
下载 Vagrant 的公钥，名为 vagrant.pub</p>
<p>或者使用命令</p>
<pre><code>wget https://raw.githubusercontent.com/mitchellh/vagrant/master/keys/vagrant.pub
</code></pre>
</li>
<li>
<p>安装 SSH 服务</p>
<pre><code>sudo apt-get update
sudo apt-get install openssh-server
</code></pre>
</li>
<li>
<p>添加 Vagrant 的公钥</p>
<pre><code>mkdir ~/.ssh
chmod 700 ~/.ssh
touch ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
cat vagrant.pub &gt;&gt; ~/.ssh/authorized_keys
</code></pre>
</li>
</ol>
</li>
<li>
<p>安装一些基本的软件，例如 git, vim, zsh, oh-my-zsh 等</p>
<p>安装完软件之后清理一下软件包</p>
<pre><code>sudo apt-get clean
</code></pre>
</li>
<li>
<p>让 Vagrant 用户使用 sudo 时不需要输入密码（必须，要不然一些 Vagrant 的功能无法实现）</p>
<p>先输入命令 <code>sudo visudo</code>, 然后在末尾添加一行，内容如下</p>
<pre><code>vagrant ALL=(ALL) NOPASSWD: ALL
</code></pre>
</li>
<li>
<p>关闭虚拟机<br>
进入虚拟机目录，例如：~/Documents/Parallels/Ubuntu-14.04.2-vagrant.pvm, 可看到一些文件和文件夹，其中需要的是以下 3 个文件和文件夹，其它的可删除</p>
<p>VmInfo.pvi<br>
config.pvs<br>
*.hdd</p>
<p>可对虚拟磁盘进行优化，减少大小</p>
<pre><code>prl_disk_tool compact --hdd *.hdd
</code></pre>
</li>
<li>
<p>打包成 base box<br>
还需要 Vagrantfile 和 metadata.json 文件，Vagrantfile 文件内容可为空，metadata.json 可如下所示</p>
<pre><code>{&quot;provider&quot;:&quot;parallels&quot;}
</code></pre>
<p>然后进行打包</p>
<pre><code>tar cvzf Ubuntu-14.04.2-parallels.box ./Ubuntu-14.04.2-vagrant.pvm ./Vagrantfile ./metadata.json
</code></pre>
</li>
<li>
<p>做好了 base box 自己得测试一下</p>
</li>
</ol>
<hr>
<p>参考资料：<br>
<a href="http://docs.vagrantup.com/v2/boxes/base.html">CREATING A BASE BOX | Vagrant</a><br>
<a href="http://parallels.github.io/vagrant-parallels/docs/boxes/base.html">Creating a Base Box | Parallels</a></p>
<h2 id="初始化和配置">初始化和配置</h2>
<ol>
<li>
<p>建立一个 Vagrant 项目目录</p>
<pre><code>mkdir ~/Vagrant
</code></pre>
</li>
<li>
<p>初始化一个项目</p>
<pre><code>cd ~/Vagrant
mkdir Ubuntu_Server_14.04
cd Ubuntu_Server_14.04
vagrant box list    # 列出现有的 box
vagrant init Ubuntu_Server_14.04
</code></pre>
<p>会在当前目录下生成一个 <code>Vagrantfile</code> 文件，用于描述你的项目（虚拟机的网络连接方式，同步文件夹等）</p>
</li>
</ol>
<h3 id="vagrantfile-配置文件">Vagrantfile 配置文件</h3>
<p>配置文件是用 Ruby 写的，不过都是一些常用的赋值</p>
<p>文件内部的解释非常清晰，就不班门弄斧了</p>
<p>对于 Parallels 虚拟机可进行如下配置：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-ruby" data-lang="ruby"><span class="line"><span class="cl"><span class="c1"># 设置端口转发，将主机的 8081 端口转发到虚拟机的 80 端口，在开发 Web 应用的时候非常有用</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="s2">&#34;forwarded_port&#34;</span><span class="p">,</span> <span class="ss">guest</span><span class="p">:</span> <span class="mi">80</span><span class="p">,</span> <span class="ss">host</span><span class="p">:</span> <span class="mi">8081</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 将主机的 /Users/mwum/Code 文件夹共享到虚拟机的 /home/vagrant/Code 文件夹</span>
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&#34;/Users/mwum/Code&#34;</span><span class="p">,</span> <span class="s2">&#34;/home/vagrant/Code&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&#34;parallels&#34;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Virtual Machine Name</span>
</span></span><span class="line"><span class="cl">  <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;Ubuntu-14.04-parallels&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Parallels Tools Auto-Update</span>
</span></span><span class="line"><span class="cl">  <span class="n">v</span><span class="o">.</span><span class="n">update_guest_tools</span> <span class="o">=</span> <span class="kp">true</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># Memory</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># v.memory = 1024</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h4 id="默认共享目录">默认共享目录</h4>
<p>默认主机的项目目录和虚拟机中的 /vagrant 目录是共享的</p>
<h2 id="使用">使用</h2>
<p>以下命令在项目目录中执行</p>
<ul>
<li><code>vagrant up</code> - 启动虚拟机，如果一个项目第一次执行，它会初始化一个虚拟机</li>
<li><code>vagrant ssh</code> - 连接虚拟机</li>
<li><code>vagrant halt</code> - 关闭虚拟机，普通的关机</li>
<li><code>vagrant suspend</code> - 关闭虚拟机，类似休眠</li>
<li><code>vagrant reload</code> - 重启虚拟机</li>
<li><code>vagrant destroy</code> - 删除虚拟机，虚拟机没了但是 box 还在</li>
</ul>
<p>更多命令请看《<a href="http://docs.vagrantup.com/v2/cli/index.html">官方文档 - COMMAND-LINE INTERFACE</a>》</p>
<h2 id="打包成-box">打包成 box</h2>
<p>当你自定义了开发环境之后，在项目目录执行命令</p>
<pre><code>vagrant package
</code></pre>
<p>在此目录会生成一个 <code>package.box</code> 文件，将这个 box 给其它开发人员，就能保证你们的开发环境相同了</p>
<p>或者使用命令 <code>vagrant package -h</code> 查看更详尽的用法，例如使用</p>
<pre><code>vagrant package --include readme.txt --vagrantfile Vagrantfile
</code></pre>
<p>但是发现个问题，下次使用 <code>vagrant box add</code> 和 <code>vagrant init</code> 添加和初始化好这个 box 之后，然后使用 <code>vagrant up</code> 会出现警告大致是说 <code>.vagrant.d/boxes/boxname/0/virtualbox/include/_Vagrantfile:5: warning: already initialized constant VAGRANTFILE_API_VERSION</code>, 出现这个问题的原因呢就是项目的当前目录有个 Vagrantfile, 并且我们用上面的命令把 Vagrantfile 也添加到了 box 中<br>
解决的办法就是，如果要用 box 中的 Vagrantfile 那么把 <code>.vagrant.d/boxes/boxname/0/virtualbox/include/_Vagrantfile</code> 文件重命名为 <code>Vagrantfile</code> 并覆盖项目目录中的 Vagrantfile; 如果不用它，那么将其删除</p>
<h2 id="自动化">自动化</h2>
<p>若想统一开发环境和生产环境也是可以的，将虚拟机系统环境配置成相同的环境即可</p>
<p>若想让两个环境完全一样，并实现自动化配置，可以尝试 <a href="/chef-basic-flow/">Chef</a> 或 <a href="http://puppetlabs.com/">Puppet</a></p>
<h2 id="心得">心得</h2>
<p>使用一段时间这个环境之后：Mac + VirtualBox + Vagrant<br>
有个问题，使用 Public Networks 网络方式的时候，与外网的连接不是很好</p>
<p>而且我还用着 Parallels 虚拟机，于是尝试了 <a href="https://github.com/Parallels/vagrant-parallels">vagrant-parallels</a> 插件，使之能用 Vagrant 来管理 Parallels 虚拟机<br>
官方文档：<a href="http://parallels.github.io/vagrant-parallels/docs/">http://parallels.github.io/vagrant-parallels/docs/</a><br>
当使用 Vagrant 启动 Parallels 虚拟机的时候，会出现 Gui 窗口，为了关闭这个窗口可以按如下操作：<br>
执行 <code>prlctl set &lt;name&gt; --on-window-close keep-running</code> 命令之后，即使把窗口关了，虚拟机也在后台运行</p>
<p>使用了一段时间，在 VirtualBox 中的问题没有遇到过，也没有遇到其它问题。而且 Parallels 虚拟机的性能比 VirtualBox 虚拟机要好</p>

  </div>

  <div class="quiet-link">
      <span>上一篇：</span><a href="/ubuntu-package-dpkg-and-apt-commands/">Ubuntu 软件包管理工具 dpkg, APT 的一些命令</a><br />
      <span>下一篇：</span><a href="/install-ruby-on-mac-with-rbenv/">在 Mac 上用 rbenv 安装 ruby</a>
  </div>

</article>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'mwum'; 
     
    (function() {
        if (window.location.hostname == "localhost")
            return;

        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



  </div>
</div>

<footer class="site-footer">

  <div class="wrapper">
    <div class="footer-content">
      <p>
        <span class="no-palm">本站采用 <a rel="license" href="//creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可<br></span>
        <span>©2013-2024 <a href="https://www.dreamxu.com">明无梦</a></span>
        <span class="no-palm">| </span>
        <span>Powered by <a href="//gohugo.io/">Hugo</a></span>
        <span class="no-palm">| </span>
        <span>Hosted by <a href="//github.com/">GitHub</a></span>
        <span class="no-palm">| </span>
        <span>Designed by <a href="https://www.dreamxu.com">明无梦</a></span>
        <span class="no-laptop"><a rel="license" href="//creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a></span>
      </p>
    </div>

  </div>

</footer>


</body>

</html>
